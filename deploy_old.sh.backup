#!/bin/bash

# æ±‚èŒç®¡ç†ç³»ç»Ÿä¸€é”®éƒ¨ç½²è„šæœ¬
# ä½œè€…: GitHub Copilot
# æ—¥æœŸ: 2025-10-23
# ç”¨æ³•: bash deploy.sh [dev|prod]

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é¡¹ç›®è·¯å¾„ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
PROJECT_DIR="/root/JobApplyManagement"

# æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_header() {
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# æ˜¾ç¤ºä½¿ç”¨å¸®åŠ©
show_help() {
    echo ""
    echo "ğŸš€ æ±‚èŒç®¡ç†ç³»ç»Ÿä¸€é”®éƒ¨ç½²è„šæœ¬"
    echo ""
    echo "ç”¨æ³•:"
    echo "  bash deploy.sh [æ¨¡å¼]"
    echo ""
    echo "æ¨¡å¼:"
    echo "  dev   - å¼€å‘æ¨¡å¼ï¼ˆä½¿ç”¨ Vite å¼€å‘æœåŠ¡å™¨ï¼Œæ”¯æŒçƒ­æ›´æ–°ï¼‰"
    echo "  prod  - ç”Ÿäº§æ¨¡å¼ï¼ˆæ„å»ºé™æ€æ–‡ä»¶å¹¶éƒ¨ç½²åˆ° /var/wwwï¼‰"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  bash deploy.sh dev   # å¼€å‘æ¨¡å¼éƒ¨ç½²"
    echo "  bash deploy.sh prod  # ç”Ÿäº§æ¨¡å¼éƒ¨ç½²"
    echo ""
}

# æ£€æŸ¥å¿…è¦çš„å‘½ä»¤
check_dependencies() {
    print_header "æ£€æŸ¥ç³»ç»Ÿä¾èµ–"
    
    local missing_deps=()
    
    if ! command -v node &> /dev/null; then
        missing_deps+=("node")
    fi
    
    if ! command -v npm &> /dev/null; then
        missing_deps+=("npm")
    fi
    
    if ! command -v pm2 &> /dev/null; then
        missing_deps+=("pm2")
    fi
    
    if ! command -v nginx &> /dev/null; then
        missing_deps+=("nginx")
    fi
    
    if ! command -v psql &> /dev/null; then
        missing_deps+=("postgresql-client")
    fi
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        print_error "ç¼ºå°‘ä»¥ä¸‹ä¾èµ–: ${missing_deps[*]}"
        echo ""
        echo "è¯·å…ˆå®‰è£…ç¼ºå°‘çš„ä¾èµ–ï¼š"
        echo "  sudo apt update"
        echo "  sudo apt install -y nodejs npm postgresql-client nginx"
        echo "  sudo npm install -g pm2"
        exit 1
    fi
    
    print_success "æ‰€æœ‰ä¾èµ–å·²å®‰è£…"
}

# æ£€æŸ¥é¡¹ç›®ç›®å½•
check_project_dir() {
    print_header "æ£€æŸ¥é¡¹ç›®ç›®å½•"
    
    if [ ! -d "$PROJECT_DIR" ]; then
        print_error "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"
        echo ""
        echo "è¯·ä¿®æ”¹è„šæœ¬ä¸­çš„ PROJECT_DIR å˜é‡ä¸ºå®é™…é¡¹ç›®è·¯å¾„"
        exit 1
    fi
    
    cd "$PROJECT_DIR"
    print_success "é¡¹ç›®ç›®å½•: $PROJECT_DIR"
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
check_database() {
    print_header "æ£€æŸ¥æ•°æ®åº“è¿æ¥"
    
    # ä» .env æ–‡ä»¶è¯»å–æ•°æ®åº“é…ç½®
    if [ -f ".env" ]; then
        # ä½¿ç”¨ grep è€Œä¸æ˜¯ source æ¥é¿å…å˜é‡æ±¡æŸ“
        DB_USER=$(grep "^DB_USER=" .env | cut -d '=' -f2)
        DB_NAME=$(grep "^DB_NAME=" .env | cut -d '=' -f2)
        DB_HOST=$(grep "^DB_HOST=" .env | cut -d '=' -f2)
        DB_PASSWORD=$(grep "^DB_PASSWORD=" .env | cut -d '=' -f2)
    fi
    
    # ä½¿ç”¨é»˜è®¤å€¼
    DB_USER=${DB_USER:-lthero}
    DB_NAME=${DB_NAME:-job_tracker}
    DB_HOST=${DB_HOST:-localhost}
    DB_PASSWORD=${DB_PASSWORD:-}
    
    # ä½¿ç”¨ PGPASSWORD ç¯å¢ƒå˜é‡æä¾›å¯†ç 
    if PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -c "SELECT 1;" > /dev/null 2>&1; then
        print_success "æ•°æ®åº“è¿æ¥æ­£å¸¸"
    else
        print_warning "æ•°æ®åº“è¿æ¥å¤±è´¥"
        print_info "è¯·ç¡®ä¿ PostgreSQL æ­£åœ¨è¿è¡Œå¹¶ä¸”é…ç½®æ­£ç¡®"
        print_info "æ•°æ®åº“é…ç½®: ä¸»æœº=$DB_HOST ç”¨æˆ·=$DB_USER æ•°æ®åº“=$DB_NAME"
        
        read -p "æ˜¯å¦ç»§ç»­éƒ¨ç½²ï¼Ÿ(y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
}

# å®‰è£…ä¾èµ–
install_dependencies() {
    print_header "å®‰è£…é¡¹ç›®ä¾èµ–"
    
    if [ ! -d "node_modules" ]; then
        print_info "å®‰è£… npm ä¾èµ–..."
        npm install
        print_success "ä¾èµ–å®‰è£…å®Œæˆ"
    else
        print_info "æ£€æŸ¥ä¾èµ–æ›´æ–°..."
        npm install
        print_success "ä¾èµ–å·²æ˜¯æœ€æ–°"
    fi
}

# é…ç½®ç¯å¢ƒå˜é‡ - å¼€å‘æ¨¡å¼
configure_env_dev() {
    print_header "é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰"
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰ .env æ–‡ä»¶
    if [ -f ".env" ]; then
        print_warning "æ£€æµ‹åˆ°ç°æœ‰ .env æ–‡ä»¶"
        cat .env
        echo ""
        read -p "æ˜¯å¦ä¿ç•™ç°æœ‰é…ç½®ï¼Ÿ(Y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Nn]$ ]]; then
            # ç”¨æˆ·é€‰æ‹©é‡æ–°é…ç½®
            create_new_env_file "dev"
        else
            print_success "ä¿ç•™ç°æœ‰ .env é…ç½®"
        fi
    else
        # æ²¡æœ‰ .env æ–‡ä»¶ï¼Œåˆ›å»ºæ–°çš„
        create_new_env_file "dev"
    fi
}

# é…ç½®ç¯å¢ƒå˜é‡ - ç”Ÿäº§æ¨¡å¼
configure_env_prod() {
    print_header "é…ç½®ç¯å¢ƒå˜é‡ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰"
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰ .env æ–‡ä»¶
    if [ -f ".env" ]; then
        print_warning "æ£€æµ‹åˆ°ç°æœ‰ .env æ–‡ä»¶"
        cat .env
        echo ""
        read -p "æ˜¯å¦ä¿ç•™ç°æœ‰é…ç½®ï¼Ÿ(Y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Nn]$ ]]; then
            # ç”¨æˆ·é€‰æ‹©é‡æ–°é…ç½®
            create_new_env_file "prod"
        else
            print_success "ä¿ç•™ç°æœ‰ .env é…ç½®"
        fi
    else
        # æ²¡æœ‰ .env æ–‡ä»¶ï¼Œåˆ›å»ºæ–°çš„
        create_new_env_file "prod"
    fi
}

# åˆ›å»ºæ–°çš„ .env æ–‡ä»¶ï¼ˆäº¤äº’å¼æˆ–ä½¿ç”¨æ¨¡æ¿ï¼‰
create_new_env_file() {
    local mode=$1
    
    echo ""
    print_info "è¯·é€‰æ‹©é…ç½®æ–¹å¼:"
    echo "  1) ä½¿ç”¨ç¤ºä¾‹æ¨¡æ¿ï¼ˆéœ€è¦æ‰‹åŠ¨ä¿®æ”¹ï¼‰"
    echo "  2) äº¤äº’å¼è¾“å…¥é…ç½®"
    read -p "è¯·é€‰æ‹© (1/2): " -n 1 -r
    echo
    echo ""
    
    if [[ $REPLY == "2" ]]; then
        # äº¤äº’å¼è¾“å…¥
        print_info "è¯·è¾“å…¥é…ç½®ä¿¡æ¯:"
        
        read -p "æ•°æ®åº“ä¸»æœº [localhost]: " DB_HOST
        DB_HOST=${DB_HOST:-localhost}
        
        read -p "æ•°æ®åº“ç«¯å£ [5432]: " DB_PORT
        DB_PORT=${DB_PORT:-5432}
        
        read -p "æ•°æ®åº“åç§° [job_tracker]: " DB_NAME
        DB_NAME=${DB_NAME:-job_tracker}
        
        read -p "æ•°æ®åº“ç”¨æˆ· [postgres]: " DB_USER
        DB_USER=${DB_USER:-postgres}
        
        read -sp "æ•°æ®åº“å¯†ç : " DB_PASSWORD
        echo
        
        read -p "å‰ç«¯åŸŸå (å¦‚: https://yourdomain.com): " FRONTEND_URL
        
        read -p "JWTå¯†é’¥ (ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ): " JWT_SECRET
        if [ -z "$JWT_SECRET" ]; then
            JWT_SECRET=$(openssl rand -base64 32 2>/dev/null || echo "please-change-this-secret-key-$(date +%s)")
        fi
        
        # ç”Ÿæˆ .env æ–‡ä»¶
        cat > .env << EOF
# åç«¯é…ç½®
PORT=3000
DB_HOST=$DB_HOST
DB_PORT=$DB_PORT
DB_NAME=$DB_NAME
DB_USER=$DB_USER
DB_PASSWORD=$DB_PASSWORD
JWT_SECRET=$JWT_SECRET

# å‰ç«¯é…ç½®
FRONTEND_URL=$FRONTEND_URL
VITE_API_URL=${FRONTEND_URL}/api
EOF
        
        print_success "ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"
        
    else
        # ä½¿ç”¨æ¨¡æ¿
        cat > .env << 'EOF'
# åç«¯é…ç½®
PORT=3000
DB_HOST=localhost
DB_PORT=5432
DB_NAME=job_tracker
DB_USER=postgres
DB_PASSWORD=YOUR_DATABASE_PASSWORD_HERE
JWT_SECRET=your-secret-key-change-in-production-use-random-string-at-least-32-characters-long

# å‰ç«¯é…ç½®
FRONTEND_URL=https://yourdomain.com
VITE_API_URL=https://yourdomain.com/api
EOF
        
        print_success "å·²åˆ›å»º .env æ¨¡æ¿æ–‡ä»¶"
        print_warning "âš ï¸  è¯·ç«‹å³ç¼–è¾‘ .env æ–‡ä»¶ï¼Œä¿®æ”¹ä»¥ä¸‹é…ç½®:"
        print_warning "   - DB_PASSWORD: è®¾ç½®æ•°æ®åº“å¯†ç "
        print_warning "   - FRONTEND_URL: è®¾ç½®ä½ çš„åŸŸå"
        print_warning "   - JWT_SECRET: è®¾ç½®å®‰å…¨çš„å¯†é’¥"
        echo ""
        read -p "æŒ‰å›è½¦ç»§ç»­ç¼–è¾‘ .env æ–‡ä»¶..." 
        ${EDITOR:-vim} .env
    fi
}

# é…ç½® Vite
configure_vite() {
    print_header "é…ç½® Vite"
    
    cat > vite.config.js << 'EOF'
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'
import { fileURLToPath } from 'url'

const __dirname = path.dirname(fileURLToPath(import.meta.url))

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  build: {
    outDir: 'dist',
    emptyOutDir: true,
  },
  server: {
    host: true,
    port: 5173,
  }
})
EOF
    
    print_success "Vite é…ç½®å®Œæˆ"
}

# å¯åŠ¨åç«¯
start_backend() {
    print_header "å¯åŠ¨åç«¯æœåŠ¡"
    
    # åœæ­¢æ—§çš„åç«¯è¿›ç¨‹
    pm2 delete job-tracker 2>/dev/null || true
    
    # å¯åŠ¨æ–°çš„åç«¯è¿›ç¨‹
    pm2 start server/server.js --name job-tracker
    
    # ç­‰å¾…å¯åŠ¨
    sleep 3
    
    # æ£€æŸ¥çŠ¶æ€
    if pm2 list | grep -q "job-tracker.*online"; then
        print_success "åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
    else
        print_error "åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"
        pm2 logs job-tracker --lines 20
        exit 1
    fi
    
    # æµ‹è¯• API
    if curl -s http://localhost:3000/api/health > /dev/null 2>&1; then
        print_success "åç«¯ API æ­£å¸¸å“åº”"
    else
        print_warning "åç«¯ API æ— å“åº”ï¼Œè¯·æ£€æŸ¥æ—¥å¿—: pm2 logs job-tracker"
    fi
}

# å¼€å‘æ¨¡å¼éƒ¨ç½²
deploy_dev() {
    print_header "ğŸ”§ å¼€å‘æ¨¡å¼éƒ¨ç½²"
    
    # é…ç½®ç¯å¢ƒå˜é‡
    configure_env_dev
    
    # é…ç½® Vite
    configure_vite
    
    # å¯åŠ¨åç«¯
    start_backend
    
    # ä¿®å¤æƒé™
    print_header "ä¿®å¤æ–‡ä»¶æƒé™"
    chmod 755 /root
    chmod 755 "$PROJECT_DIR"
    if [ -d "dist" ]; then
        chmod -R 755 dist
    fi
    print_success "æƒé™ä¿®å¤å®Œæˆ"
    
    # åœæ­¢æ—§çš„å‰ç«¯è¿›ç¨‹
    print_header "å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨"
    pm2 delete vite 2>/dev/null || true
    
    # å¯åŠ¨ Vite å¼€å‘æœåŠ¡å™¨
    pm2 start npm --name vite -- run dev -- --host 0.0.0.0 --port 8081
    
    # ç­‰å¾…å¯åŠ¨
    sleep 5
    
    # æ£€æŸ¥çŠ¶æ€
    if pm2 list | grep -q "vite.*online"; then
        print_success "å‰ç«¯å¼€å‘æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ"
    else
        print_error "å‰ç«¯å¼€å‘æœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
        pm2 logs vite --lines 20
        exit 1
    fi
    
    # é…ç½® Nginx
    configure_nginx "dev"
    
    # æµ‹è¯•è®¿é—®
    test_deployment
    
    # æ˜¾ç¤ºéƒ¨ç½²ç»“æœ  
    show_deployment_result "dev"
}

# é…ç½® Nginx
configure_nginx() {
    local mode=$1  # dev æˆ– prod
    
    print_header "é…ç½® Nginxï¼ˆ${mode}æ¨¡å¼ï¼‰"
    
    # ä» .env è¯»å–åŸŸå
    if [ -f ".env" ]; then
        DOMAIN=$(grep "^FRONTEND_URL=" .env | cut -d '=' -f2 | sed 's|https://||' | sed 's|http://||' | sed 's|/||g')
    fi
    
    if [ -z "$DOMAIN" ]; then
        print_warning "æœªæ‰¾åˆ°åŸŸåé…ç½®"
        read -p "è¯·è¾“å…¥åŸŸå (å¦‚: yourdomain.com): " DOMAIN
    fi
    
    print_info "é…ç½®åŸŸå: $DOMAIN"
    
    # æ£€æŸ¥ SSL è¯ä¹¦æ˜¯å¦å­˜åœ¨
    SSL_CERT="/etc/letsencrypt/live/$DOMAIN/fullchain.pem"
    if [ ! -f "$SSL_CERT" ]; then
        print_warning "æœªæ‰¾åˆ° SSL è¯ä¹¦: $SSL_CERT"
        print_info "è¯·ç¡®ä¿å·²ç»ç”³è¯· Let's Encrypt è¯ä¹¦"
        print_info "æˆ–è€…æ‰‹åŠ¨é…ç½® Nginx SSL è¯ä¹¦è·¯å¾„"
        read -p "æ˜¯å¦ç»§ç»­é…ç½® Nginxï¼Ÿ(y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            return
        fi
    fi
    
    if [ "$mode" == "dev" ]; then
        # å¼€å‘æ¨¡å¼ï¼šä»£ç†åˆ° Vite å¼€å‘æœåŠ¡å™¨
        sudo tee /etc/nginx/sites-available/job-tracker > /dev/null << NGINXEOF
# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name $DOMAIN;
    return 301 https://\$host\$request_uri;
}

# HTTPS ä¸»é…ç½®
server {
    listen 443 ssl http2;
    server_name $DOMAIN;

    # SSL è¯ä¹¦
    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # æ—¥å¿—
    access_log /var/log/nginx/job-access.log;
    error_log /var/log/nginx/job-error.log;

    # API åå‘ä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass \$http_upgrade;
    }

    # å‰ç«¯ä»£ç†åˆ°å¼€å‘æœåŠ¡å™¨
    location / {
        proxy_pass http://127.0.0.1:8081;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }
}
NGINXEOF
    else
        # ç”Ÿäº§æ¨¡å¼ï¼šæä¾›é™æ€æ–‡ä»¶
        sudo tee /etc/nginx/sites-available/job-tracker > /dev/null << NGINXEOF
# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name $DOMAIN;
    return 301 https://\$host\$request_uri;
}

# HTTPS ä¸»é…ç½®
server {
    listen 443 ssl http2;
    server_name $DOMAIN;

    # SSL è¯ä¹¦
    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # æ—¥å¿—
    access_log /var/log/nginx/job-access.log;
    error_log /var/log/nginx/job-error.log;

    # API åå‘ä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass \$http_upgrade;
    }

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/job-tracker;
        try_files \$uri \$uri/ /index.html;
        index index.html;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)\$ {
        root /var/www/job-tracker;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
}
NGINXEOF
    fi
    
    sudo ln -sf /etc/nginx/sites-available/job-tracker /etc/nginx/sites-enabled/
    
    # æµ‹è¯•å¹¶é‡è½½ Nginx
    if sudo nginx -t; then
        print_success "Nginx é…ç½®æ­£ç¡®"
        sudo systemctl reload nginx
        print_success "Nginx å·²é‡è½½"
    else
        print_error "Nginx é…ç½®é”™è¯¯"
        exit 1
    fi
}
    
    # æµ‹è¯•è®¿é—®
    print_header "æµ‹è¯•è®¿é—®"
    sleep 2
    
    print_info "æµ‹è¯• API..."
    if curl -s https://job.lthero.cn/api/health | grep -q "success"; then
        print_success "API æ­£å¸¸"
    else
        print_warning "API å¯èƒ½æœªæ­£å¸¸å“åº”"
    fi
    
    # æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
    print_header "ğŸ‰ å¼€å‘æ¨¡å¼éƒ¨ç½²å®Œæˆ"
    echo ""
    echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
    pm2 list | grep -E "job-tracker|vite"
    echo ""
    echo "ğŸŒ è®¿é—®åœ°å€:"
    echo "  - å‰ç«¯: https://job.lthero.cn"
    echo "  - API:  https://job.lthero.cn/api"
    echo ""
    echo "ğŸ“‹ ç®¡ç†å‘½ä»¤:"
    echo "  - æŸ¥çœ‹åç«¯æ—¥å¿—: pm2 logs job-tracker"
    echo "  - æŸ¥çœ‹å‰ç«¯æ—¥å¿—: pm2 logs vite"
    echo "  - é‡å¯åç«¯:    pm2 restart job-tracker"
    echo "  - é‡å¯å‰ç«¯:    pm2 restart vite"
    echo "  - æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹: pm2 list"
    echo ""
    echo "ğŸ’¡ æç¤º:"
    echo "  - å¼€å‘æ¨¡å¼æ”¯æŒçƒ­æ›´æ–°ï¼ˆHMRï¼‰"
    echo "  - ä¿®æ”¹ä»£ç åä¼šè‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨"
    echo "  - å¦‚éœ€åˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼ï¼Œè¿è¡Œ: bash deploy.sh prod"
    echo ""
}

# ç”Ÿäº§æ¨¡å¼éƒ¨ç½²
deploy_prod() {
    print_header "ğŸš€ ç”Ÿäº§æ¨¡å¼éƒ¨ç½²"
    
    # é…ç½®ç¯å¢ƒå˜é‡
    configure_env_prod
    
    # é…ç½® Vite
    configure_vite
    
    # æ¸…ç†æ—§æ–‡ä»¶
    print_header "æ¸…ç†æ—§æ„å»ºæ–‡ä»¶"
    rm -rf dist build node_modules/.vite
    print_success "æ¸…ç†å®Œæˆ"
    
    # æ„å»ºå‰ç«¯
    print_header "æ„å»ºå‰ç«¯"
    npm run build
    
    # æ£€æŸ¥æ„å»ºç»“æœ
    if [ ! -d "dist" ]; then
        print_error "æ„å»ºå¤±è´¥ï¼dist ç›®å½•ä¸å­˜åœ¨"
        exit 1
    fi
    
    print_success "å‰ç«¯æ„å»ºæˆåŠŸ"
    echo ""
    print_info "æ„å»ºäº§ç‰©:"
    ls -lh dist/ | head -10
    echo ""
    
    # éƒ¨ç½²åˆ° /var/www
    print_header "éƒ¨ç½²é™æ€æ–‡ä»¶åˆ° /var/www"
    sudo mkdir -p /var/www/job-tracker
    sudo rm -rf /var/www/job-tracker/*
    sudo cp -r dist/* /var/www/job-tracker/
    sudo chown -R www-data:www-data /var/www/job-tracker
    sudo chmod -R 755 /var/www/job-tracker
    print_success "é™æ€æ–‡ä»¶éƒ¨ç½²å®Œæˆ"
    
    # å¯åŠ¨åç«¯
    start_backend
    
    # åœæ­¢å¼€å‘æœåŠ¡å™¨ï¼ˆå¦‚æœåœ¨è¿è¡Œï¼‰
    pm2 delete vite 2>/dev/null || true
    
    # é…ç½® Nginx
    print_header "é…ç½® Nginxï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰"
    
    sudo tee /etc/nginx/sites-available/job-tracker > /dev/null << 'NGINXEOF'
# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name job.lthero.cn;
    return 301 https://$host$request_uri;
}

# HTTPS ä¸»é…ç½®
server {
    listen 443 ssl http2;
    server_name job.lthero.cn;

    # SSL è¯ä¹¦
    ssl_certificate /etc/letsencrypt/live/job.lthero.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/job.lthero.cn/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # æ—¥å¿—
    access_log /var/log/nginx/job-access.log;
    error_log /var/log/nginx/job-error.log;

    # API åå‘ä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/job-tracker;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /var/www/job-tracker;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
}
NGINXEOF
    
    sudo ln -sf /etc/nginx/sites-available/job-tracker /etc/nginx/sites-enabled/
    
    # æµ‹è¯•å¹¶é‡è½½ Nginx
    if sudo nginx -t; then
        print_success "Nginx é…ç½®æ­£ç¡®"
        sudo systemctl reload nginx
        print_success "Nginx å·²é‡è½½"
    else
        print_error "Nginx é…ç½®é”™è¯¯"
        exit 1
    fi
    
    # æµ‹è¯•è®¿é—®
    print_header "æµ‹è¯•è®¿é—®"
    sleep 2
    
    print_info "æµ‹è¯• API..."
    if curl -s https://job.lthero.cn/api/health | grep -q "success"; then
        print_success "API æ­£å¸¸"
    else
        print_warning "API å¯èƒ½æœªæ­£å¸¸å“åº”"
    fi
    
    print_info "æµ‹è¯•é¦–é¡µ..."
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://job.lthero.cn/)
    if [ "$HTTP_CODE" = "200" ]; then
        print_success "é¦–é¡µæ­£å¸¸ (HTTP $HTTP_CODE)"
    else
        print_warning "é¦–é¡µè¿”å› HTTP $HTTP_CODE"
    fi
    
    # æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
    print_header "ğŸ‰ ç”Ÿäº§æ¨¡å¼éƒ¨ç½²å®Œæˆ"
    echo ""
    echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
    pm2 list | grep job-tracker
    echo ""
    echo "ğŸŒ è®¿é—®åœ°å€:"
    echo "  - å‰ç«¯: https://job.lthero.cn"
    echo "  - API:  https://job.lthero.cn/api"
    echo ""
    echo "ğŸ“¦ éƒ¨ç½²ä¿¡æ¯:"
    echo "  - é™æ€æ–‡ä»¶: /var/www/job-tracker"
    echo "  - åç«¯æœåŠ¡: PM2 ç®¡ç† (job-tracker)"
    echo ""
    echo "ğŸ“‹ ç®¡ç†å‘½ä»¤:"
    echo "  - æŸ¥çœ‹åç«¯æ—¥å¿—:   pm2 logs job-tracker"
    echo "  - é‡å¯åç«¯:      pm2 restart job-tracker"
    echo "  - æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€:   pm2 list"
    echo "  - æŸ¥çœ‹ Nginx æ—¥å¿—: sudo tail -f /var/log/nginx/job-error.log"
    echo ""
    echo "ğŸ’¡ æç¤º:"
    echo "  - é™æ€æ–‡ä»¶å·²ä¼˜åŒ–ï¼ˆGzip + ç¼“å­˜ï¼‰"
    echo "  - ä¿®æ”¹ä»£ç åéœ€é‡æ–°æ„å»º: bash deploy.sh prod"
    echo "  - å¦‚éœ€åˆ‡æ¢åˆ°å¼€å‘æ¨¡å¼ï¼Œè¿è¡Œ: bash deploy.sh dev"
    echo ""
}

# ä¸»å‡½æ•°
main() {
    # æ˜¾ç¤ºæ ‡é¢˜
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘   æ±‚èŒç®¡ç†ç³»ç»Ÿ - ä¸€é”®éƒ¨ç½²è„šæœ¬          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    # æ£€æŸ¥å‚æ•°
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    MODE=$1
    
    # éªŒè¯æ¨¡å¼å‚æ•°
    if [ "$MODE" != "dev" ] && [ "$MODE" != "prod" ]; then
        print_error "æ— æ•ˆçš„éƒ¨ç½²æ¨¡å¼: $MODE"
        show_help
        exit 1
    fi
    
    # ç¡®è®¤éƒ¨ç½²
    echo "éƒ¨ç½²æ¨¡å¼: $([ "$MODE" == "dev" ] && echo "å¼€å‘æ¨¡å¼ (Development)" || echo "ç”Ÿäº§æ¨¡å¼ (Production)")"
    echo "é¡¹ç›®è·¯å¾„: $PROJECT_DIR"
    echo ""
    read -p "ç¡®è®¤éƒ¨ç½²ï¼Ÿ(y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_warning "éƒ¨ç½²å·²å–æ¶ˆ"
        exit 0
    fi
    echo ""
    
    # æ£€æŸ¥ä¾èµ–
    check_dependencies
    
    # æ£€æŸ¥é¡¹ç›®ç›®å½•
    check_project_dir
    
    # æ£€æŸ¥æ•°æ®åº“
    check_database
    
    # å®‰è£…ä¾èµ–
    install_dependencies
    
    # æ ¹æ®æ¨¡å¼éƒ¨ç½²
    if [ "$MODE" == "dev" ]; then
        deploy_dev
    else
        deploy_prod
    fi
    
    # é…ç½®é˜²ç«å¢™
    print_header "é…ç½®é˜²ç«å¢™ï¼ˆå®‰å…¨åŠ å›ºï¼‰"
    
    if command -v ufw &> /dev/null; then
        print_info "æ£€æµ‹åˆ° UFW é˜²ç«å¢™ï¼Œé…ç½®å®‰å…¨è§„åˆ™..."
        
        # å…è®¸ SSHï¼ˆé‡è¦ï¼ï¼‰
        sudo ufw allow 22/tcp
        
        # å…è®¸ HTTP å’Œ HTTPS
        sudo ufw allow 80/tcp
        sudo ufw allow 443/tcp
        
        # ç¡®ä¿åç«¯ç«¯å£ä¸å¯¹å¤–å¼€æ”¾ï¼ˆåªç›‘å¬ localhostï¼‰
        # æ£€æŸ¥æ˜¯å¦æœ‰è§„åˆ™å¼€æ”¾äº† 3000 ç«¯å£
        if sudo ufw status | grep -q "3000"; then
            print_warning "æ£€æµ‹åˆ° 3000 ç«¯å£å·²å¼€æ”¾ï¼Œå»ºè®®å…³é—­"
            read -p "æ˜¯å¦å…³é—­ 3000 ç«¯å£çš„å¤–ç½‘è®¿é—®ï¼Ÿ(Y/n) " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
                sudo ufw delete allow 3000/tcp 2>/dev/null || true
                print_success "å·²å…³é—­ 3000 ç«¯å£çš„å¤–ç½‘è®¿é—®"
            fi
        fi
        
        # å¯ç”¨é˜²ç«å¢™
        print_info "å¯ç”¨é˜²ç«å¢™..."
        echo "y" | sudo ufw enable
        
        echo ""
        print_success "é˜²ç«å¢™é…ç½®å®Œæˆ"
        echo ""
        print_info "å½“å‰é˜²ç«å¢™è§„åˆ™:"
        sudo ufw status numbered
        echo ""
        print_warning "å®‰å…¨æç¤º: åç«¯ 3000 ç«¯å£åªåº”ç›‘å¬ localhostï¼Œä¸å¯¹å¤–å¼€æ”¾"
    else
        print_warning "æœªæ£€æµ‹åˆ° UFW é˜²ç«å¢™"
        echo ""
        print_info "å»ºè®®æ‰‹åŠ¨é…ç½®é˜²ç«å¢™è§„åˆ™:"
        echo "  sudo apt install ufw"
        echo "  sudo ufw allow 22/tcp   # SSH"
        echo "  sudo ufw allow 80/tcp   # HTTP"
        echo "  sudo ufw allow 443/tcp  # HTTPS"
        echo "  sudo ufw enable"
        echo ""
        print_warning "é‡è¦: ä¸è¦å¼€æ”¾ 3000 ç«¯å£ï¼"
    fi
    
    # ä¿å­˜ PM2 é…ç½®
    print_header "ä¿å­˜ PM2 é…ç½®"
    pm2 save
    print_success "PM2 é…ç½®å·²ä¿å­˜"
    
    # å®Œæˆ
    echo ""
    print_success "æ‰€æœ‰éƒ¨ç½²æ­¥éª¤å·²å®Œæˆï¼"
    echo ""
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
